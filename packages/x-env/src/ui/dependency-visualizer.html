<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X-Env Dependency Visualizer</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/d3@7"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.5rem;
    }

    .header p {
      font-size: 1.1rem;
      color: #64748b;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .filter-btn:hover {
      border-color: #cbd5e1;
    }

    .filter-btn.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      min-height: 600px;
    }

    .visualization-panel {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .panel-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    .panel-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #0f172a;
    }

    .graph-container {
      height: 500px;
      position: relative;
    }

    .details-panel {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .variable-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .variable-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s;
    }

    .variable-item:hover {
      background: #f8fafc;
    }

    .variable-item:last-child {
      border-bottom: none;
    }

    .variable-name {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 0.25rem;
    }

    .variable-meta {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.125rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge.type {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge.required {
      background: #fecaca;
      color: #dc2626;
    }

    .badge.optional {
      background: #d1fae5;
      color: #059669;
    }

    .badge.npm {
      background: #fef3c7;
      color: #d97706;
    }

    .badge.monorepo {
      background: #e0e7ff;
      color: #5b21b6;
    }

    .badge.local {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .variable-description {
      color: #64748b;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .variable-source {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: #64748b;
      font-size: 0.875rem;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #64748b;
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    /* D3 Graph Styles */
    .node {
      cursor: pointer;
    }

    .node circle {
      stroke: #fff;
      stroke-width: 2px;
    }

    .node.project circle {
      fill: #3b82f6;
    }

    .node.package circle {
      fill: #10b981;
    }

    .node.variable circle {
      fill: #f59e0b;
    }

    .node text {
      font-size: 12px;
      fill: #374151;
      text-anchor: middle;
      dominant-baseline: middle;
    }

    .link {
      stroke: #94a3b8;
      stroke-width: 2px;
      fill: none;
    }

    .link.depends {
      stroke: #3b82f6;
    }

    .link.provides {
      stroke: #10b981;
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 1000;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <header class="header">
        <h1>X-Env Dependency Visualizer</h1>
        <p>Visualize environment variable dependencies across your project and packages</p>
      </header>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{ stats.totalVariables }}</div>
          <div class="stat-label">Total Variables</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.totalPackages }}</div>
          <div class="stat-label">Dependencies</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.requiredVariables }}</div>
          <div class="stat-label">Required Variables</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.monorepoProjects }}</div>
          <div class="stat-label">Monorepo Projects</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="search-box">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.39zM11 18a7 7 0 1 1 7-7 7 7 0 0 1-7 7z"/>
          </svg>
          <input 
            type="text" 
            v-model="searchQuery" 
            placeholder="Search variables, packages, or descriptions..."
          >
        </div>
        <div class="filter-buttons">
          <button 
            class="filter-btn" 
            :class="{ active: activeFilter === 'all' }"
            @click="setFilter('all')"
          >
            All
          </button>
          <button 
            class="filter-btn" 
            :class="{ active: activeFilter === 'npm' }"
            @click="setFilter('npm')"
          >
            NPM Packages
          </button>
          <button 
            class="filter-btn" 
            :class="{ active: activeFilter === 'monorepo' }"
            @click="setFilter('monorepo')"
          >
            Monorepo
          </button>
          <button 
            class="filter-btn" 
            :class="{ active: activeFilter === 'required' }"
            @click="setFilter('required')"
          >
            Required Only
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Visualization Panel -->
        <div class="visualization-panel">
          <div class="panel-header">
            <h2 class="panel-title">Dependency Graph</h2>
          </div>
          <div class="graph-container" ref="graphContainer">
            <div v-if="loading" class="loading">
              Loading dependency graph...
            </div>
            <div v-if="error" class="error">
              {{ error }}
            </div>
          </div>
        </div>

        <!-- Details Panel -->
        <div class="details-panel">
          <div class="panel-header">
            <h2 class="panel-title">Environment Variables</h2>
          </div>
          <div class="variable-list">
            <div 
              v-for="variable in filteredVariables" 
              :key="`${variable.source}-${variable.variable}`"
              class="variable-item"
              @click="selectVariable(variable)"
            >
              <div class="variable-name">{{ variable.variable }}</div>
              <div class="variable-meta">
                <span class="badge type">{{ variable.type }}</span>
                <span class="badge" :class="variable.required ? 'required' : 'optional'">
                  {{ variable.required ? 'Required' : 'Optional' }}
                </span>
                <span class="badge" :class="variable.category">
                  {{ variable.category }}
                </span>
              </div>
              <div v-if="variable.description" class="variable-description">
                {{ variable.description }}
              </div>
              <div class="variable-source">
                From: {{ variable.source }}
                <span v-if="variable.defaultValue !== undefined">
                  â€¢ Default: {{ variable.defaultValue }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tooltip -->
    <div ref="tooltip" class="tooltip" style="display: none;"></div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue

    createApp({
      setup() {
        // Reactive state
        const loading = ref(true)
        const error = ref('')
        const searchQuery = ref('')
        const activeFilter = ref('all')
        const variables = ref([])
        const graphData = ref({ nodes: [], edges: [] })
        const selectedVariable = ref(null)
        const graphContainer = ref(null)
        const tooltip = ref(null)

        // Computed properties
        const filteredVariables = computed(() => {
          let filtered = variables.value

          // Apply search filter
          if (searchQuery.value) {
            const query = searchQuery.value.toLowerCase()
            filtered = filtered.filter(v => 
              v.variable.toLowerCase().includes(query) ||
              v.source.toLowerCase().includes(query) ||
              (v.description && v.description.toLowerCase().includes(query))
            )
          }

          // Apply category filter
          if (activeFilter.value !== 'all') {
            if (activeFilter.value === 'required') {
              filtered = filtered.filter(v => v.required)
            } else {
              filtered = filtered.filter(v => v.category === activeFilter.value)
            }
          }

          return filtered.sort((a, b) => {
            // Sort by required first, then alphabetically
            if (a.required !== b.required) {
              return b.required - a.required
            }
            return a.variable.localeCompare(b.variable)
          })
        })

        const stats = computed(() => {
          const totalVariables = variables.value.length
          const totalPackages = new Set(variables.value.map(v => v.source)).size
          const requiredVariables = variables.value.filter(v => v.required).length
          const monorepoProjects = variables.value.filter(v => v.category === 'monorepo').length

          return {
            totalVariables,
            totalPackages,
            requiredVariables,
            monorepoProjects,
          }
        })

        // Methods
        const setFilter = (filter) => {
          activeFilter.value = filter
        }

        const selectVariable = (variable) => {
          selectedVariable.value = variable
          highlightVariableInGraph(variable)
        }

        const highlightVariableInGraph = (variable) => {
          // Highlight the selected variable in the graph
          d3.selectAll('.node')
            .classed('highlighted', false)
            .classed('dimmed', true)

          d3.selectAll('.link')
            .classed('highlighted', false)
            .classed('dimmed', true)

          // Highlight the selected variable and its connections
          const variableNodeId = `${variable.source}:${variable.variable}`
          d3.select(`[data-id="${variableNodeId}"]`)
            .classed('highlighted', true)
            .classed('dimmed', false)

          d3.select(`[data-id="${variable.source}"]`)
            .classed('highlighted', true)
            .classed('dimmed', false)
        }

        const loadData = async () => {
          try {
            loading.value = true
            error.value = ''

            // Simulate API call - replace with actual API
            await new Promise(resolve => setTimeout(resolve, 1000))

            // Mock data - replace with actual data from your resolver
            const mockVariables = [
              {
                variable: 'API_KEY',
                source: 'auth-service',
                type: 'string',
                required: true,
                description: 'Authentication API key for external services',
                category: 'npm'
              },
              {
                variable: 'DATABASE_URL',
                source: 'db-connector',
                type: 'string',
                required: true,
                description: 'PostgreSQL database connection string',
                category: 'npm'
              },
              {
                variable: 'PORT',
                source: 'web-server',
                type: 'number',
                required: false,
                defaultValue: 3000,
                description: 'Server port number',
                category: 'monorepo'
              },
              {
                variable: 'DEBUG',
                source: 'logger-utils',
                type: 'boolean',
                required: false,
                defaultValue: false,
                description: 'Enable debug logging',
                category: 'monorepo'
              },
              {
                variable: 'REDIS_URL',
                source: 'cache-service',
                type: 'string',
                required: true,
                description: 'Redis connection URL for caching',
                category: 'npm'
              }
            ]

            const mockGraphData = {
              nodes: [
                { id: 'my-project', name: 'My Project', type: 'project', category: 'local' },
                { id: 'auth-service', name: 'auth-service', type: 'package', category: 'npm', variableCount: 1, version: '1.2.0' },
                { id: 'db-connector', name: 'db-connector', type: 'package', category: 'npm', variableCount: 1, version: '2.1.0' },
                { id: 'web-server', name: 'web-server', type: 'package', category: 'monorepo', variableCount: 1 },
                { id: 'logger-utils', name: 'logger-utils', type: 'package', category: 'monorepo', variableCount: 1 },
                { id: 'cache-service', name: 'cache-service', type: 'package', category: 'npm', variableCount: 1, version: '3.0.1' },
                { id: 'auth-service:API_KEY', name: 'API_KEY', type: 'variable', category: 'npm' },
                { id: 'db-connector:DATABASE_URL', name: 'DATABASE_URL', type: 'variable', category: 'npm' },
                { id: 'web-server:PORT', name: 'PORT', type: 'variable', category: 'monorepo' },
                { id: 'logger-utils:DEBUG', name: 'DEBUG', type: 'variable', category: 'monorepo' },
                { id: 'cache-service:REDIS_URL', name: 'REDIS_URL', type: 'variable', category: 'npm' }
              ],
              edges: [
                { source: 'my-project', target: 'auth-service', type: 'depends', variables: ['API_KEY'] },
                { source: 'my-project', target: 'db-connector', type: 'depends', variables: ['DATABASE_URL'] },
                { source: 'my-project', target: 'web-server', type: 'depends', variables: ['PORT'] },
                { source: 'my-project', target: 'logger-utils', type: 'depends', variables: ['DEBUG'] },
                { source: 'my-project', target: 'cache-service', type: 'depends', variables: ['REDIS_URL'] },
                { source: 'auth-service', target: 'auth-service:API_KEY', type: 'provides' },
                { source: 'db-connector', target: 'db-connector:DATABASE_URL', type: 'provides' },
                { source: 'web-server', target: 'web-server:PORT', type: 'provides' },
                { source: 'logger-utils', target: 'logger-utils:DEBUG', type: 'provides' },
                { source: 'cache-service', target: 'cache-service:REDIS_URL', type: 'provides' }
              ]
            }

            variables.value = mockVariables
            graphData.value = mockGraphData

            await nextTick()
            renderGraph()

          } catch (err) {
            error.value = err.message || 'Failed to load dependency data'
          } finally {
            loading.value = false
          }
        }

        const renderGraph = () => {
          if (!graphContainer.value || !graphData.value.nodes.length) return

          const container = d3.select(graphContainer.value)
          container.selectAll('*').remove()

          const width = graphContainer.value.clientWidth
          const height = graphContainer.value.clientHeight

          const svg = container
            .append('svg')
            .attr('width', width)
            .attr('height', height)

          const g = svg.append('g')

          // Create zoom behavior
          const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
              g.attr('transform', event.transform)
            })

          svg.call(zoom)

          // Create force simulation
          const simulation = d3.forceSimulation(graphData.value.nodes)
            .force('link', d3.forceLink(graphData.value.edges).id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2))

          // Create links
          const link = g.append('g')
            .selectAll('line')
            .data(graphData.value.edges)
            .enter()
            .append('line')
            .attr('class', d => `link ${d.type}`)

          // Create nodes
          const node = g.append('g')
            .selectAll('g')
            .data(graphData.value.nodes)
            .enter()
            .append('g')
            .attr('class', d => `node ${d.type}`)
            .attr('data-id', d => d.id)
            .call(d3.drag()
              .on('start', dragstarted)
              .on('drag', dragged)
              .on('end', dragended))

          // Add circles to nodes
          node.append('circle')
            .attr('r', d => {
              if (d.type === 'project') return 20
              if (d.type === 'package') return 15
              return 8
            })

          // Add labels to nodes
          node.append('text')
            .text(d => d.name)
            .attr('dy', d => d.type === 'variable' ? 25 : -25)
            .style('font-size', d => d.type === 'variable' ? '10px' : '12px')

          // Add tooltips
          node
            .on('mouseover', function(event, d) {
              const tooltipContent = createTooltipContent(d)
              tooltip.value.innerHTML = tooltipContent
              tooltip.value.style.display = 'block'
              tooltip.value.style.left = (event.pageX + 10) + 'px'
              tooltip.value.style.top = (event.pageY - 10) + 'px'
            })
            .on('mouseout', function() {
              tooltip.value.style.display = 'none'
            })
            .on('click', function(event, d) {
              if (d.type === 'variable') {
                const [source, variable] = d.id.split(':')
                const variableData = variables.value.find(v => 
                  v.source === source && v.variable === variable
                )
                if (variableData) {
                  selectVariable(variableData)
                }
              }
            })

          // Update positions on simulation tick
          simulation.on('tick', () => {
            link
              .attr('x1', d => d.source.x)
              .attr('y1', d => d.source.y)
              .attr('x2', d => d.target.x)
              .attr('y2', d => d.target.y)

            node
              .attr('transform', d => `translate(${d.x},${d.y})`)
          })

          // Drag functions
          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart()
            d.fx = d.x
            d.fy = d.y
          }

          function dragged(event, d) {
            d.fx = event.x
            d.fy = event.y
          }

          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0)
            d.fx = null
            d.fy = null
          }
        }

        const createTooltipContent = (d) => {
          if (d.type === 'project') {
            return `<strong>${d.name}</strong><br>Type: Project`
          } else if (d.type === 'package') {
            return `<strong>${d.name}</strong><br>Type: ${d.category} package<br>Variables: ${d.variableCount}${d.version ? `<br>Version: ${d.version}` : ''}`
          } else if (d.type === 'variable') {
            const [source, variable] = d.id.split(':')
            const variableData = variables.value.find(v => 
              v.source === source && v.variable === variable
            )
            return `<strong>${variable}</strong><br>Source: ${source}<br>Type: ${variableData?.type || 'unknown'}${variableData?.required ? '<br>Required' : ''}`
          }
          return d.name
        }

        // Lifecycle
        onMounted(() => {
          loadData()
          
          // Handle window resize
          window.addEventListener('resize', () => {
            setTimeout(renderGraph, 100)
          })
        })

        return {
          loading,
          error,
          searchQuery,
          activeFilter,
          variables,
          filteredVariables,
          stats,
          graphContainer,
          tooltip,
          setFilter,
          selectVariable,
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
