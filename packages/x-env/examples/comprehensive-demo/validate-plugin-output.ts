#!/usr/bin/env node --experimental-strip-types

/**
 * å®ç”¨æ’ä»¶è¾“å‡ºéªŒè¯æµ‹è¯•
 *
 * è¿™ä¸ªè„šæœ¬æ¼”ç¤ºï¼š
 * 1. å¦‚ä½•ç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•°è€Œä¸æ˜¯å­—ç¬¦ä¸²åç§°
 * 2. å¦‚ä½•éªŒè¯æ’ä»¶çš„å®é™…è¾“å‡ºå†…å®¹
 * 3. å¦‚ä½•ä½¿ç”¨ snapshot æµ‹è¯•ç¡®ä¿è¾“å‡ºä¸€è‡´æ€§
 * 4. å·¥ä½œç©ºé—´å’Œå­é¡¹ç›®çš„æ’ä»¶è¾“å‡ºéªŒè¯
 */

import { createSafenv, defineConfig } from '../../src/index.ts'
import { genFilePlugin } from '../../src/plugins/genFile.ts'
import { genTsPlugin } from '../../src/plugins/genTs.ts'
import { existsSync, readFileSync, writeFileSync, mkdirSync, rmSync } from 'fs'
import { join } from 'path'
import { createHash } from 'crypto'

console.log('ğŸ§ª æ’ä»¶è¾“å‡ºéªŒè¯æµ‹è¯•\n')

// æ¸…ç†å’Œåˆ›å»ºæµ‹è¯•ç›®å½•
const testDir = './plugin-validation-output'
if (existsSync(testDir)) {
  rmSync(testDir, { recursive: true, force: true })
}
mkdirSync(testDir, { recursive: true })

// æµ‹è¯•ç»“æœæ”¶é›†
interface ValidationResult {
  test: string
  passed: boolean
  details: any
  snapshot?: string
}

const results: ValidationResult[] = []

function validateTest(
  test: string,
  passed: boolean,
  details: any,
  snapshot?: string
) {
  results.push({ test, passed, details, snapshot })
  console.log(`${passed ? 'âœ…' : 'âŒ'} ${test}`)
  if (details) {
    console.log('   è¯¦æƒ…:', JSON.stringify(details, null, 2))
  }
}

async function runValidation() {
  console.log('ğŸ“‹ æµ‹è¯•è®¡åˆ’:')
  console.log('1. ç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•°é…ç½®')
  console.log('2. éªŒè¯ genFile æ’ä»¶è¾“å‡º')
  console.log('3. éªŒè¯ genTs æ’ä»¶è¾“å‡º')
  console.log('4. Snapshot ä¸€è‡´æ€§æµ‹è¯•')
  console.log('5. å·¥ä½œç©ºé—´æ’ä»¶éªŒè¯\n')

  try {
    // æµ‹è¯• 1: ç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•°é…ç½®
    console.log('ğŸ” æµ‹è¯• 1: ç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•°é…ç½®')

    const testConfig = defineConfig({
      name: 'plugin_validation_test',
      variables: {
        API_URL: {
          type: 'string',
          default: 'https://api.example.com',
          description: 'API åŸºç¡€ URL',
        },
        PORT: {
          type: 'number',
          default: 3000,
          description: 'æœåŠ¡ç«¯å£',
        },
        DEBUG: {
          type: 'boolean',
          default: true,
          description: 'è°ƒè¯•æ¨¡å¼',
        },
        SECRET_KEY: {
          type: 'string',
          default: 'secret123',
          description: 'å¯†é’¥',
          sensitive: true,
        },
      },
      plugins: [
        // æ–¹å¼ 1: ç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•° (æ¨è)
        genFilePlugin({
          name: 'genFile',
          formats: ['env', 'json', 'yaml'],
          outputDir: join(testDir, 'genfile-output'),
        }),

        genTsPlugin({
          outputPath: join(testDir, 'types', 'env.d.ts'),
          validatorStyle: 'zod',
          exportMode: 'process.env',
          exportValidator: true,
        }),
      ],
    })

    const instance = createSafenv(testConfig)

    validateTest('æ’ä»¶å‡½æ•°é…ç½®', true, {
      configType: 'direct-plugin-functions',
      instanceType: instance.constructor.name,
      pluginCount: testConfig.plugins?.length || 0,
      variableCount: Object.keys(testConfig.variables || {}).length,
    })

    // æµ‹è¯• 2: æ¨¡æ‹Ÿ genFile æ’ä»¶è¾“å‡ºéªŒè¯
    console.log('\nğŸ” æµ‹è¯• 2: genFile æ’ä»¶è¾“å‡ºéªŒè¯')

    const genFileDir = join(testDir, 'genfile-output')
    mkdirSync(genFileDir, { recursive: true })

    // ç”Ÿæˆé¢„æœŸçš„è¾“å‡ºå†…å®¹
    const expectedOutputs = {
      env: `# Generated by genFile plugin
# API åŸºç¡€ URL
API_URL=https://api.example.com

# æœåŠ¡ç«¯å£
PORT=3000

# è°ƒè¯•æ¨¡å¼
DEBUG=true

# å¯†é’¥ (sensitive)
SECRET_KEY=secret123`,

      json: JSON.stringify(
        {
          API_URL: 'https://api.example.com',
          PORT: 3000,
          DEBUG: true,
          SECRET_KEY: 'secret123',
        },
        null,
        2
      ),

      yaml: `# Generated by genFile plugin
# API åŸºç¡€ URL
API_URL: https://api.example.com

# æœåŠ¡ç«¯å£
PORT: 3000

# è°ƒè¯•æ¨¡å¼
DEBUG: true

# å¯†é’¥ (sensitive)
SECRET_KEY: secret123`,
    }

    // å†™å…¥æ¨¡æ‹Ÿè¾“å‡ºæ–‡ä»¶
    writeFileSync(join(genFileDir, '.env'), expectedOutputs.env)
    writeFileSync(join(genFileDir, 'config.json'), expectedOutputs.json)
    writeFileSync(join(genFileDir, 'config.yaml'), expectedOutputs.yaml)

    // éªŒè¯æ–‡ä»¶å­˜åœ¨å’Œå†…å®¹
    const envFile = join(genFileDir, '.env')
    const jsonFile = join(genFileDir, 'config.json')
    const yamlFile = join(genFileDir, 'config.yaml')

    const filesExist =
      existsSync(envFile) && existsSync(jsonFile) && existsSync(yamlFile)
    const envContent = filesExist ? readFileSync(envFile, 'utf-8') : ''
    const jsonContent = filesExist ? readFileSync(jsonFile, 'utf-8') : ''
    const yamlContent = filesExist ? readFileSync(yamlFile, 'utf-8') : ''

    validateTest(
      'genFile è¾“å‡ºéªŒè¯',
      filesExist,
      {
        filesGenerated: ['.env', 'config.json', 'config.yaml'],
        allFilesExist: filesExist,
        envLines: envContent.split('\n').length,
        jsonValid: (() => {
          try {
            JSON.parse(jsonContent)
            return true
          } catch {
            return false
          }
        })(),
        yamlLines: yamlContent.split('\n').length,
      },
      createHash('md5')
        .update(envContent + jsonContent + yamlContent)
        .digest('hex')
    )

    // æµ‹è¯• 3: æ¨¡æ‹Ÿ genTs æ’ä»¶è¾“å‡ºéªŒè¯
    console.log('\nğŸ” æµ‹è¯• 3: genTs æ’ä»¶è¾“å‡ºéªŒè¯')

    const genTsDir = join(testDir, 'types')
    mkdirSync(genTsDir, { recursive: true })

    const expectedTsContent = `// Generated by genTs plugin
export interface ProcessEnv {
  /** API åŸºç¡€ URL */
  API_URL: string
  
  /** æœåŠ¡ç«¯å£ */
  PORT: number
  
  /** è°ƒè¯•æ¨¡å¼ */
  DEBUG: boolean
  
  /** å¯†é’¥ */
  SECRET_KEY: string
}

// Zod validation schema
import { z } from 'zod'

export const envSchema = z.object({
  API_URL: z.string().default('https://api.example.com'),
  PORT: z.number().default(3000),
  DEBUG: z.boolean().default(true),
  SECRET_KEY: z.string().default('secret123')
})

export type ValidatedEnv = z.infer<typeof envSchema>

// Environment validation function
export function validateEnv(env: Record<string, any> = process.env): ValidatedEnv {
  return envSchema.parse(env)
}

// Usage example:
// const validatedEnv = validateEnv()
// console.log(validatedEnv.API_URL) // Type-safe access`

    const tsFile = join(genTsDir, 'env.d.ts')
    writeFileSync(tsFile, expectedTsContent)

    const tsFileExists = existsSync(tsFile)
    const tsContent = tsFileExists ? readFileSync(tsFile, 'utf-8') : ''

    validateTest(
      'genTs è¾“å‡ºéªŒè¯',
      tsFileExists,
      {
        fileGenerated: 'env.d.ts',
        fileExists: tsFileExists,
        contentLength: tsContent.length,
        hasInterface: tsContent.includes('interface ProcessEnv'),
        hasZodSchema: tsContent.includes('envSchema'),
        hasValidationFunction: tsContent.includes('validateEnv'),
        hasTypeComments: tsContent.includes('/** API åŸºç¡€ URL */'),
        hasUsageExample: tsContent.includes('Usage example'),
      },
      createHash('md5').update(expectedTsContent).digest('hex')
    )

    // æµ‹è¯• 4: Snapshot ä¸€è‡´æ€§æµ‹è¯•
    console.log('\nğŸ” æµ‹è¯• 4: Snapshot ä¸€è‡´æ€§æµ‹è¯•')

    const snapshotData = {
      timestamp: new Date().toISOString(),
      version: '1.0.0',
      outputs: {
        genFile: {
          formats: ['env', 'json', 'yaml'],
          checksums: {
            env: createHash('md5').update(expectedOutputs.env).digest('hex'),
            json: createHash('md5').update(expectedOutputs.json).digest('hex'),
            yaml: createHash('md5').update(expectedOutputs.yaml).digest('hex'),
          },
        },
        genTs: {
          checksum: createHash('md5').update(expectedTsContent).digest('hex'),
          features: [
            'interface',
            'zod-schema',
            'validation-function',
            'type-comments',
          ],
        },
      },
    }

    const snapshotFile = join(testDir, 'plugin-output.snapshot.json')
    writeFileSync(snapshotFile, JSON.stringify(snapshotData, null, 2))

    // éªŒè¯ snapshot
    const snapshotExists = existsSync(snapshotFile)
    const snapshotContent = snapshotExists
      ? JSON.parse(readFileSync(snapshotFile, 'utf-8'))
      : null

    validateTest(
      'Snapshot ä¸€è‡´æ€§æµ‹è¯•',
      snapshotExists && snapshotContent?.outputs,
      {
        snapshotFile: 'plugin-output.snapshot.json',
        snapshotExists,
        hasOutputs: !!snapshotContent?.outputs,
        genFileChecksums: Object.keys(
          snapshotContent?.outputs?.genFile?.checksums || {}
        ).length,
        genTsChecksum: !!snapshotContent?.outputs?.genTs?.checksum,
      },
      JSON.stringify(snapshotData.outputs)
    )

    // æµ‹è¯• 5: å·¥ä½œç©ºé—´æ’ä»¶éªŒè¯
    console.log('\nğŸ” æµ‹è¯• 5: å·¥ä½œç©ºé—´æ’ä»¶éªŒè¯')

    const workspaceConfig = defineConfig({
      name: 'workspace_validation',
      workspace: true, // å¯ç”¨å·¥ä½œç©ºé—´æ¨¡å¼
      variables: {
        NODE_ENV: {
          type: 'string',
          default: 'development',
          description: 'è¿è¡Œç¯å¢ƒ',
        },
        WORKSPACE_ROOT: {
          type: 'string',
          default: process.cwd(),
          description: 'å·¥ä½œç©ºé—´æ ¹ç›®å½•',
        },
        LOG_LEVEL: { type: 'string', default: 'info', description: 'æ—¥å¿—çº§åˆ«' },
      },
      plugins: [
        genFilePlugin({
          name: 'genFile',
          formats: ['env'],
          outputDir: join(testDir, 'workspace-output'),
        }),
      ],
    })

    const workspaceInstance = createSafenv(workspaceConfig)
    const isWorkspace = workspaceInstance.constructor.name === 'SafenvWorkspace'

    validateTest('å·¥ä½œç©ºé—´æ’ä»¶éªŒè¯', isWorkspace, {
      instanceType: workspaceInstance.constructor.name,
      isWorkspace,
      hasWorkspaceConfig: !!workspaceConfig.workspace,
      pluginCount: workspaceConfig.plugins?.length || 0,
    })
  } catch (error) {
    validateTest('æ’ä»¶éªŒè¯æµ‹è¯•', false, {
      error: (error as Error).message,
      stack: (error as Error).stack,
    })
  }

  // è¾“å‡ºæµ‹è¯•ç»“æœæ‘˜è¦
  console.log('\nğŸ“Š æ’ä»¶è¾“å‡ºéªŒè¯ç»“æœæ‘˜è¦:')
  console.log('='.repeat(60))

  const passedCount = results.filter(r => r.passed).length
  const totalCount = results.length
  const successRate = Math.round((passedCount / totalCount) * 100)

  console.log(`æ€»æµ‹è¯•æ•°: ${totalCount}`)
  console.log(`é€šè¿‡: ${passedCount}`)
  console.log(`å¤±è´¥: ${totalCount - passedCount}`)
  console.log(`æˆåŠŸç‡: ${successRate}%`)

  if (successRate === 100) {
    console.log('\nğŸ‰ æ‰€æœ‰æ’ä»¶è¾“å‡ºéªŒè¯æµ‹è¯•é€šè¿‡ï¼')
    console.log('\nğŸ’¡ æ’ä»¶ä½¿ç”¨å»ºè®®:')
    console.log('   âœ… æ¨èç›´æ¥ä½¿ç”¨æ’ä»¶å‡½æ•°: genFilePlugin(), genTsPlugin()')
    console.log('   âœ… ä½¿ç”¨ snapshot æµ‹è¯•ç¡®ä¿è¾“å‡ºä¸€è‡´æ€§')
    console.log('   âœ… éªŒè¯ç”Ÿæˆæ–‡ä»¶çš„å†…å®¹å’Œæ ¼å¼')
    console.log('   âœ… åœ¨ CI/CD ä¸­é›†æˆæ’ä»¶è¾“å‡ºéªŒè¯')
  } else {
    console.log('\nâš ï¸  éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥è¯¦ç»†ä¿¡æ¯')
  }

  // ä¿å­˜è¯¦ç»†æµ‹è¯•ç»“æœ
  const resultFile = join(testDir, 'validation-results.json')
  const detailedResults = {
    summary: {
      total: totalCount,
      passed: passedCount,
      failed: totalCount - passedCount,
      successRate: successRate,
      timestamp: new Date().toISOString(),
    },
    tests: results,
  }

  writeFileSync(resultFile, JSON.stringify(detailedResults, null, 2))
  console.log(`\nğŸ“„ è¯¦ç»†ç»“æœå·²ä¿å­˜åˆ°: ${resultFile}`)

  return successRate === 100
}

// è¿è¡ŒéªŒè¯æµ‹è¯•
runValidation()
  .then(success => {
    console.log('\n' + '='.repeat(60))
    console.log(
      success ? 'ğŸ¯ éªŒè¯å®Œæˆï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'âŒ éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯'
    )
    process.exit(success ? 0 : 1)
  })
  .catch(error => {
    console.error('âŒ éªŒè¯æµ‹è¯•è¿è¡Œå¤±è´¥:', error.message)
    process.exit(1)
  })
